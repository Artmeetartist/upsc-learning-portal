<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Default to dark mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPSC Interactive Learning Roadmap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF Library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-tertiary: #374151; /* gray-700 */
            --text-primary: #f9fafb; /* gray-50 */
            --text-secondary: #d1d5db; /* gray-300 */
            --accent-primary: #f97316; /* orange-500 */
            --accent-secondary: #ea580c; /* orange-600 */
            --border-color: #4b5563; /* gray-600 */
            --correct-color: #10B981; /* green-500 */
            --incorrect-color: #EF4444; /* red-500 */
        }

        html:not(.dark) {
            --bg-primary: #f9fafb; /* gray-50 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #f3f4f6; /* gray-100 */
            --text-primary: #111827; /* gray-900 */
            --text-secondary: #374151; /* gray-700 */
            --accent-primary: #f97316; /* orange-500 */
            --accent-secondary: #ea580c; /* orange-600 */
            --border-color: #e5e7eb; /* gray-200 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-accent { color: var(--accent-primary); }
        .border-themed { border-color: var(--border-color); }
        .hover-bg-tertiary:hover { background-color: var(--bg-tertiary); }
        .hover-border-accent:hover { border-color: var(--accent-secondary); }

        .quiz-option.correct { background-color: var(--correct-color) !important; color: white !important; }
        .quiz-option.incorrect { background-color: var(--incorrect-color) !important; color: white !important; }
        .quiz-option[disabled] { cursor: not-allowed; }

        /* Roadmap Styles */
        .roadmap-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--border-color);
            transform: translateX(-50%);
        }
        .roadmap-subject {
            position: relative;
        }
        .roadmap-topic {
            position: relative;
            padding-left: 40px; /* Space for the line and circle */
        }
        .roadmap-topic::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            background-color: var(--bg-secondary);
            transform: translateY(-50%);
            z-index: 1;
        }
        .roadmap-topic::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 32px;
            height: 2px;
            background-color: var(--border-color);
            transform: translateY(-50%);
        }
        .topic-completed .roadmap-topic::before {
            background-color: var(--correct-color);
            border-color: var(--correct-color);
        }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary .arrow { transform: rotate(90deg); }
    </style>
</head>
<body>

    <div id="app" class="container mx-auto p-4 md:p-8">
        <!-- Main Content -->
        <main id="mainContent">
            <!-- Header -->
            <header class="text-center mb-12 relative">
                <h1 class="text-4xl md:text-5xl font-bold text-accent">UPSC Exam Roadmap</h1>
                <p class="text-secondary mt-2">Your AI-Powered Preparation Guide</p>
                <button id="themeToggle" class="absolute top-0 right-0 p-2 rounded-full hover-bg-tertiary">
                    <svg id="theme-icon-light" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-dark" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </header>

            <!-- Subject Selection Screen -->
            <div id="subjectSelection">
                <!-- Content generated by JS -->
            </div>

            <!-- Roadmap Container -->
            <div id="roadmapContainer" class="hidden">
                 <button id="backButton" class="mb-8 bg-tertiary hover:bg-cyan-600 font-bold py-2 px-4 rounded-lg transition-colors">&larr; Back to Subjects</button>
                <div id="roadmapContent" class="space-y-12"></div>
            </div>

            <!-- Mock Test Container -->
            <div id="mockTestContainer" class="hidden">
                <!-- Mock test UI will be rendered here -->
            </div>
        </main>
        
        <!-- Modals and Overlays -->
        <div id="loader" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center hidden">
             <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-accent-primary"></div>
                <p id="loaderText" class="mt-4 text-white">Generating content...</p>
            </div>
        </div>
        <div id="errorMessage" class="hidden fixed bottom-5 right-5 max-w-sm bg-red-900/80 border border-red-700 text-red-300 px-4 py-3 rounded-lg z-50"></div>
        <div id="contentModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-40 flex justify-center items-center p-4">
            <div id="modal-container" class="bg-secondary rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col transition-all duration-300">
                <div class="flex justify-between items-center p-4 border-t border-b border-themed">
                    <h2 id="modalTitle" class="text-2xl font-bold text-accent"></h2>
                     <div class="flex items-center gap-4">
                        <button id="markCompleteBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm">Mark as Complete</button>
                        <button id="closeModal" class="text-secondary hover:text-primary text-3xl leading-none">&times;</button>
                    </div>
                </div>
                <div class="flex border-b border-themed">
                    <button id="conceptTab" class="flex-1 p-3 bg-tertiary text-primary font-semibold">Key Concepts</button>
                    <button id="quizTab" class="flex-1 p-3 text-secondary font-semibold">Practice MCQs</button>
                </div>
                <div id="modalContent" class="p-6 overflow-y-auto flex-grow"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // DOM Elements
        const themeToggle = document.getElementById('themeToggle');
        const subjectSelection = document.getElementById('subjectSelection');
        const roadmapContainer = document.getElementById('roadmapContainer');
        const roadmapContent = document.getElementById('roadmapContent');
        const backButton = document.getElementById('backButton');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const errorMessage = document.getElementById('errorMessage');
        const contentModal = document.getElementById('contentModal');
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modalTitle');
        const closeModalButton = document.getElementById('closeModal');
        const conceptTab = document.getElementById('conceptTab');
        const quizTab = document.getElementById('quizTab');
        const modalContent = document.getElementById('modalContent');
        const markCompleteBtn = document.getElementById('markCompleteBtn');
        const mockTestContainer = document.getElementById('mockTestContainer');

        // App State
        let apiKey = 'AIzaSyC_IIToAdeoUyPod0DfUBNu_kDBD8f5seg';
        let currentTopic = null;
        let currentSubject = null;
        let currentTopicCache = {};
        let quizState = { questions: [], currentQuestionIndex: 0, score: 0, userAnswers: [] };
        let mockTestState = { questions: [], currentQuestionIndex: 0, score: 0, userAnswers: [], timer: null, timeLeft: 0 };
        let progress = {};

        const upscSyllabus = {
            "Paper I: General Studies": {
                "Current Affairs": ["National and international events of importance", "Political and economic developments", "Important social issues", "Locations in news"],
                "Indian History & Indian National Movement": ["Ancient & Medieval History", "Major dynasties and their contributions", "Important events and personalities", "Modern Indian History (Mid-18th century onwards)", "Freedom struggle phases and personalities", "Important events and issues", "Post-independence consolidation and reorganization"],
                "Geography": ["Universe & Earth Evolution", "Earth's Interior, Geology & Rock Systems", "Geomorphic Processes", "Earthquakes and Volcanism", "Distribution of Continents and Oceans", "Landforms and their evolution", "Atmosphere structure", "Insolation and Heat Budget", "Air Mass, Fronts, Cyclones and Jet Streams", "Wind and Pressure Belts", "Precipitation patterns", "Climate Zones of the World", "Hydrosphere", "Submarine Relief Features", "Temperature and Salinity", "Waves, Ocean Currents, Tides", "Marine Resources", "Ocean Deposits and Corals", "Demography and Census", "Human Development", "Economic Activities", "Transport and Communication", "International Trade", "Settlement patterns", "Physiography of India", "Drainage System", "Climate patterns", "Soils in India", "Natural Vegetation", "Population distribution", "Agriculture and productivity", "Industry and recent developments", "Transport systems", "Continents, Countries, and Cities", "Important geographical locations"],
                "Indian Polity & Governance": ["Constitution of India", "Historical Background", "Preamble", "Fundamental Rights", "Directive Principles of State Policy (DPSP)", "Fundamental Duties", "Constitutional Amendments", "President and Executive", "Prime Minister and Council of Ministers", "Parliament structure and functions", "State Government", "Local Government (Panchayati Raj)", "Supreme Court", "High Courts", "Subordinate Courts", "Judicial Review and Activism", "Centre-State Relations", "Emergency Provisions", "Constitutional and Non-Constitutional Bodies", "Political Parties", "Elections and Electoral Reforms", "Anti-Defection Law", "Good Governance", "E-Governance", "Right to Information (RTI)", "Public Policies"],
                "Economy": ["Macro and Microeconomics", "Economic Measurement", "Inflation types and causes", "National Income", "Functions of Money", "Financial Markets", "Indian Banking System", "Budgeting process", "Fiscal Policy", "Centre-State Financial Relations", "Tax Structure", "Planning History in India", "NITI Aayog", "Poverty and Employment", "Government Schemes and Programmes", "Foreign Trade", "International Organizations"],
                "Environment & Ecology": ["Origin of Life", "Ecosystems", "Biodiversity", "Pollution types and control", "Climate Change", "Conservation strategies"],
                "General Science": ["Recent Developments", "Daily Life Applications", "ISRO missions", "Satellites and Space Exploration", "Digital India", "Cybersecurity", "5G, AI, Machine Learning", "Blockchain Technology", "Missiles and Defence Systems", "DRDO developments", "Nuclear Power Plants", "Nuclear Treaties", "India's Nuclear Policy", "Genome Editing", "GM Crops", "Biosafety measures"],
                "Art & Culture": ["Architecture from ancient to modern times", "Painting traditions", "Pottery and crafts", "Performing Arts", "Major works from ancient to modern times"]
            },
            "Paper II: CSAT (Qualifying)": {
                "Comprehension": ["Reading Comprehension Passages"],
                "Logical Reasoning": ["Analytical Reasoning", "Verbal Reasoning"],
                "Quantitative Aptitude": ["Number System", "Arithmetic", "Data Interpretation"]
            },
            "Prelims Mock Tests": {
                "Mock Tests": ["GS Paper I Mock Test", "CSAT Paper II Mock Test"]
            }
        };

        // --- Progress Management (using localStorage) ---
        const loadProgress = () => {
            const savedProgress = localStorage.getItem('upscRoadmapProgress');
            progress = savedProgress ? JSON.parse(savedProgress) : {};
        };

        const saveProgress = () => {
            localStorage.setItem('upscRoadmapProgress', JSON.stringify(progress));
        };

        const handleMarkAsComplete = () => {
            if (!progress[currentSubject]) {
                progress[currentSubject] = [];
            }
            if (!progress[currentSubject].includes(currentTopic)) {
                progress[currentSubject].push(currentTopic);
                saveProgress();
                updateMarkCompleteButton();
                renderRoadmap(currentSubject);
            }
        };

        const updateMarkCompleteButton = () => {
            const isCompleted = progress[currentSubject]?.includes(currentTopic);
            if (isCompleted) {
                markCompleteBtn.textContent = 'Completed âœ”';
                markCompleteBtn.disabled = true;
                markCompleteBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                markCompleteBtn.classList.add('bg-gray-500', 'cursor-not-allowed');
            } else {
                markCompleteBtn.textContent = 'Mark as Complete';
                markCompleteBtn.disabled = false;
                markCompleteBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                markCompleteBtn.classList.remove('bg-gray-500', 'cursor-not-allowed');
            }
        };

        // --- Theme Management ---
        const applyTheme = (theme) => {
            const isDark = theme === 'dark';
            document.documentElement.classList.toggle('dark', isDark);
            document.getElementById('theme-icon-light').classList.toggle('hidden', isDark);
            document.getElementById('theme-icon-dark').classList.toggle('hidden', !isDark);
        };

        const handleThemeToggle = () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        };

        // --- API Communication ---
        async function fetchWithExponentialBackoff(prompt, isJson = false) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: {} };
            if (isJson) payload.generationConfig.responseMimeType = "application/json";

            let retries = 3, delay = 1000;
            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody.error?.message || 'Unknown error'}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content.parts.length > 0) {
                        let content = result.candidates[0].content.parts[0].text;
                        if (isJson) {
                            content = content.replace(/^```json\s*/, '').replace(/```$/, '');
                            try {
                                return JSON.parse(content);
                            } catch (parseError) {
                                console.error("Failed to parse JSON response:", content);
                                throw new Error("API returned invalid JSON format.");
                            }
                        }
                        return content;
                    } else {
                        if (result.promptFeedback && result.promptFeedback.blockReason) throw new Error(`API call blocked: ${result.promptFeedback.blockReason}`);
                        throw new Error("No content received from API.");
                    }
                } catch (error) {
                    console.error(`Attempt failed: ${error.message}`);
                    retries--;
                    if (retries === 0) throw error;
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        }

        // --- UI Rendering & Notifications ---
        function showLoader(show, text = 'Generating content...') { 
            loaderText.textContent = text;
            loader.classList.toggle('hidden', !show);
        }
        function showError(message) { 
            errorMessage.textContent = `Error: ${message}`;
            errorMessage.classList.remove('hidden');
            setTimeout(() => errorMessage.classList.add('hidden'), 5000);
        }
        
        function renderSubjectSelection() {
            let html = '';
            for (const paper in upscSyllabus) {
                html += `<h2 class="text-2xl font-bold text-center mb-4 mt-8 col-span-1 sm:col-span-2 lg:col-span-3 xl:col-span-4">${paper}</h2>`;
                for (const subject in upscSyllabus[paper]) {
                     html += `
                        <button data-subject="${subject}" class="bg-secondary border border-themed rounded-lg p-6 text-center hover-bg-tertiary hover-border-accent transition-all duration-300 transform hover:scale-105">
                            <h3 class="text-xl font-bold text-accent">${subject}</h3>
                        </button>
                    `;
                }
            }
            subjectSelection.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">${html}</div>`;
        }
        
        function renderRoadmap(subject) {
            const topics = upscSyllabus["Paper I: General Studies"][subject] || upscSyllabus["Paper II: CSAT (Qualifying)"][subject];
            roadmapContent.innerHTML = '';
            if (!topics || !Array.isArray(topics) || topics.length === 0) {
                roadmapContent.innerHTML = `<p class="text-secondary text-center">No topics found for this subject.</p>`;
                return;
            }
            const mainPath = document.createElement('div');
            mainPath.className = 'relative flex flex-col items-center';
            const completedTopics = progress[subject] || [];

            mainPath.innerHTML = `
                <div class="roadmap-subject w-full md:w-2/3 lg:w-1/2">
                    <div class="roadmap-line"></div>
                    <h2 class="text-3xl font-bold text-accent text-center mb-8">${subject}</h2>
                    <div class="space-y-3">
                        ${topics.map(topic => {
                            const isCompleted = completedTopics.includes(topic);
                            return `
                            <div class="${isCompleted ? 'topic-completed' : ''}">
                                <div class="roadmap-topic">
                                    <button data-subject="${subject}" data-topic="${topic}" class="text-left text-secondary hover:text-primary transition-colors text-lg">
                                        ${topic}
                                    </button>
                                </div>
                            </div>
                            `
                        }).join('')}
                    </div>
                </div>
            `;
            roadmapContent.appendChild(mainPath);
        }

        function renderContent(content) {
            const sections = content.split('## ').slice(1);
            let htmlContent = sections.map(section => {
                const lines = section.split('\n');
                const title = lines[0].trim();
                const body = lines.slice(1).join('<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                return `
                    <details class="bg-primary rounded-lg mb-2" open>
                        <summary class="p-4 cursor-pointer flex justify-between items-center font-semibold text-primary">
                            ${title}
                            <svg class="w-5 h-5 arrow transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </summary>
                        <div class="p-4 border-t border-themed text-secondary">
                            ${body}
                        </div>
                    </details>
                `;
            }).join('');
            modalContent.innerHTML = htmlContent;
        }

        function renderQuizContainer(quizData) {
            modalContent.innerHTML = `<div id="quiz-panel" class="bg-primary p-4 rounded-lg flex flex-col max-w-2xl mx-auto"></div>`;
            initializeQuiz(quizData);
        }

        function initializeQuiz(quizData) {
            quizState = { questions: quizData, currentQuestionIndex: 0, score: 0, userAnswers: [] };
            renderQuiz();
        }

        function renderQuiz() {
            const quizPanel = document.getElementById('quiz-panel');
            if (!quizState.questions || !Array.isArray(quizState.questions) || quizState.questions.length === 0) {
                quizPanel.innerHTML = `<p class="text-secondary">Could not generate a quiz.</p>`;
                return;
            }

            if (quizState.currentQuestionIndex >= quizState.questions.length) {
                renderScoreboard();
                return;
            }

            const q = quizState.questions[quizState.currentQuestionIndex];
            quizPanel.innerHTML = `
                <div class="flex-grow flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-accent">Multiple Choice Quiz</h3>
                        <p class="text-sm text-secondary">${quizState.currentQuestionIndex + 1} / ${quizState.questions.length}</p>
                    </div>
                    <p class="text-secondary mb-4 h-24 overflow-y-auto">${q.question}</p>
                    <div id="quiz-options" class="space-y-2">
                        ${q.options.map((opt, i) => `<button data-index="${i}" class="quiz-option w-full text-left p-3 bg-tertiary hover-bg-tertiary rounded-md transition-colors">${opt}</button>`).join('')}
                    </div>
                </div>
                <div id="quiz-feedback" class="mt-4"></div>
            `;

            const optionButtons = quizPanel.querySelectorAll('.quiz-option');
            optionButtons.forEach(btn => btn.addEventListener('click', handleOptionSelect));
        }
        
        function handleOptionSelect(e) {
            const selectedButton = e.target;
            const selectedIndex = parseInt(selectedButton.dataset.index);
            const q = quizState.questions[quizState.currentQuestionIndex];
            const isCorrect = q.options[selectedIndex] === q.answer;

            if (isCorrect) {
                quizState.score++;
            }
            quizState.userAnswers[quizState.currentQuestionIndex] = selectedIndex;

            const optionButtons = document.querySelectorAll('.quiz-option');
            optionButtons.forEach(btn => btn.disabled = true);

            const correctIndex = q.options.indexOf(q.answer);
            optionButtons[correctIndex].classList.add('correct');
            if (!isCorrect) {
                selectedButton.classList.add('incorrect');
            }

            showQuizFeedback(q.explanation);
        }

        function showQuizFeedback(explanation) {
            const feedbackPanel = document.getElementById('quiz-feedback');
            feedbackPanel.innerHTML = `
                <div class="p-4 bg-tertiary/50 rounded-lg">
                    <h4 class="font-bold text-accent mb-2">Explanation</h4>
                    <p class="text-secondary text-sm">${explanation}</p>
                </div>
                <div class="flex justify-between mt-4">
                    <button id="prev-q-btn" class="bg-tertiary hover:bg-cyan-700 text-primary font-bold py-2 px-4 rounded-md transition-colors">Previous</button>
                    <button id="next-q-btn" class="bg-accent hover:bg-cyan-500 text-primary font-bold py-2 px-4 rounded-md transition-colors">${quizState.currentQuestionIndex === quizState.questions.length - 1 ? 'Submit' : 'Next'}</button>
                </div>
            `;
            document.getElementById('next-q-btn').addEventListener('click', () => {
                quizState.currentQuestionIndex++;
                renderQuiz();
            });
            document.getElementById('prev-q-btn').addEventListener('click', () => {
                quizState.currentQuestionIndex--;
                renderQuiz();
            });
        }

        function renderScoreboard() {
            const quizPanel = document.getElementById('quiz-panel');
            const finalScore = Math.round((quizState.score / quizState.questions.length) * 100);
            quizPanel.innerHTML = `
                <div class="text-center flex-grow flex flex-col justify-center items-center">
                    <h3 class="text-2xl font-bold text-accent">Quiz Complete!</h3>
                    <p class="text-secondary mt-4">Your Score:</p>
                    <p class="text-6xl font-bold text-primary my-2">${finalScore}<span class="text-3xl text-secondary">/100</span></p>
                    <div class="flex gap-4 mt-6">
                        <button id="restart-quiz-btn" class="bg-tertiary hover:bg-cyan-700 text-primary font-bold py-2 px-6 rounded-md transition-colors">Retake Quiz</button>
                        <button id="new-quiz-btn" class="bg-accent hover:bg-cyan-500 text-primary font-bold py-2 px-6 rounded-md transition-colors">New Quiz</button>
                    </div>
                    <button id="download-pdf-btn" class="mt-4 w-full max-w-xs bg-secondary hover-bg-tertiary border border-themed text-primary font-bold py-2 px-4 rounded-md transition-colors">Download PDF</button>
                </div>
            `;
            document.getElementById('restart-quiz-btn').addEventListener('click', () => {
                initializeQuiz(quizState.questions);
            });
            document.getElementById('new-quiz-btn').addEventListener('click', () => {
                handleTabClick('quiz', true);
            });
            document.getElementById('download-pdf-btn').addEventListener('click', generateQuizPDF);
        }
        
        function generateQuizPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 15;

            doc.setFontSize(18);
            doc.text(`UPSC Quiz Results: ${currentTopic}`, 10, y);
            y += 10;

            quizState.questions.forEach((q, index) => {
                if (y > 270) { // New page if content overflows
                    doc.addPage();
                    y = 15;
                }
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                const questionText = doc.splitTextToSize(`Q${index + 1}: ${q.question}`, 180);
                doc.text(questionText, 10, y);
                y += (questionText.length * 5) + 5;
                
                doc.setFont(undefined, 'normal');
                q.options.forEach((opt, optIndex) => {
                    const isCorrect = opt === q.answer;
                    const isUserChoice = quizState.userAnswers[index] === optIndex;

                    if (isCorrect) doc.setTextColor(0, 150, 0); // Green
                    else if (isUserChoice) doc.setTextColor(255, 0, 0); // Red
                    
                    doc.text(`${optIndex + 1}. ${opt}`, 15, y);
                    doc.setTextColor(0, 0, 0); // Reset color
                    y += 7;
                });

                doc.setFont(undefined, 'bold');
                doc.text("Explanation:", 15, y);
                y += 5;
                doc.setFont(undefined, 'normal');
                const explanationText = doc.splitTextToSize(q.explanation, 170);
                doc.text(explanationText, 15, y);
                y += (explanationText.length * 5) + 10;
            });

            doc.save(`${currentTopic}_Quiz_Results.pdf`);
        }

        // --- Event Handlers & Logic ---
        function handleTopicClick(topic, subject) {
            currentTopic = topic;
            currentSubject = subject;
            currentTopicCache = {};
            modalTitle.textContent = topic;
            updateMarkCompleteButton();
            contentModal.classList.remove('hidden');
            handleTabClick('concept');
        }

        async function handleTabClick(tabName, forceRefresh = false) {
            [conceptTab, quizTab].forEach(tab => {
                if(tab) {
                    tab.classList.remove('bg-tertiary', 'text-primary');
                    tab.classList.add('text-secondary');
                }
            });
            const activeTab = document.getElementById(`${tabName}Tab`);
            activeTab.classList.add('bg-tertiary', 'text-primary');
            activeTab.classList.remove('text-secondary');

            if (forceRefresh) currentTopicCache[tabName] = null;

            if (currentTopicCache[tabName]) {
                if(tabName === 'concept') renderContent(currentTopicCache.concept);
                else if(tabName === 'quiz') renderQuizContainer(currentTopicCache.quiz);
                return;
            }

            modalContent.innerHTML = `<div class="text-center p-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-accent-primary"></div><p class="mt-2 text-secondary">Generating content...</p></div>`;

            try {
                let prompt = '';
                if (tabName === 'concept') {
                    prompt = `Explain the key concepts of "${currentTopic}" for the UPSC Prelims exam, focusing on the parent subject "${currentSubject}". Structure the response with markdown subheadings (## Sub-topic).`;
                    const concept = await fetchWithExponentialBackoff(prompt);
                    currentTopicCache.concept = concept;
                    renderContent(concept);
                } else if (tabName === 'quiz') {
                    prompt = `Generate a 15-question multiple-choice quiz (MCQs) for the UPSC Prelims level on the topic of "${currentTopic}" from the subject "${currentSubject}". The questions should test fundamental and important concepts. Provide a JSON array of objects, where each object has "question" (string), "options" (an array of 4 strings), "answer" (a string that matches one of the options), and "explanation" (a detailed string explaining the correct answer).`;
                    const quizData = await fetchWithExponentialBackoff(prompt, true);
                    currentTopicCache.quiz = quizData;
                    renderQuizContainer(quizData);
                }
            } catch (error) {
                modalContent.innerHTML = `<div class="text-red-400">Failed to load content: ${error.message}</div>`;
            }
        }
        
        function handleCloseModal() {
            contentModal.classList.add('hidden');
        }

        // --- Initial Setup ---
        function main() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
            loadProgress();
            renderSubjectSelection();
        }

        themeToggle.addEventListener('click', handleThemeToggle);
        closeModalButton.addEventListener('click', handleCloseModal);
        conceptTab.addEventListener('click', () => handleTabClick('concept'));
        quizTab.addEventListener('click', () => handleTabClick('quiz'));
        markCompleteBtn.addEventListener('click', handleMarkAsComplete);
        
        subjectSelection.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-subject]');
            if (button) {
                currentSubject = button.dataset.subject;
                if (currentSubject === "Mock Tests") {
                    // Handle mock test selection
                } else {
                    subjectSelection.classList.add('hidden');
                    renderRoadmap(currentSubject);
                    roadmapContainer.classList.remove('hidden');
                }
            }
        });

        backButton.addEventListener('click', () => {
            roadmapContainer.classList.add('hidden');
            subjectSelection.classList.remove('hidden');
        });

        roadmapContent.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-topic]');
            if (button) {
                handleTopicClick(button.dataset.topic, button.dataset.subject);
            }
        });

        main();
        
    </script>
</body>
</html>
